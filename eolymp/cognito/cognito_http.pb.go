// Code generated by protoc-gen-go-server. DO NOT EDIT.
// See https://github.com/eolymp/contracts/tree/main/cmd/protoc-gen-go-server for more details.

package cognito

import (
	context "context"
	oauth "github.com/eolymp/go-packages/oauth"
	mux "github.com/gorilla/mux"
	prometheus "github.com/prometheus/client_golang/prometheus"
	promauto "github.com/prometheus/client_golang/prometheus/promauto"
	codes "google.golang.org/grpc/codes"
	status "google.golang.org/grpc/status"
	protojson "google.golang.org/protobuf/encoding/protojson"
	proto "google.golang.org/protobuf/proto"
	ioutil "io/ioutil"
	http "net/http"
	time "time"
)

// _Cognito_HTTPReadRequestBody parses body into proto.Message
func _Cognito_HTTPReadRequestBody(r *http.Request, v proto.Message) error {
	data, err := ioutil.ReadAll(r.Body)
	if err != nil {
		return err
	}

	if err := (protojson.UnmarshalOptions{DiscardUnknown: true}.Unmarshal(data, v)); err != nil {
		return err
	}

	return nil
}

// _Cognito_HTTPWriteResponse writes proto.Message to HTTP response
func _Cognito_HTTPWriteResponse(w http.ResponseWriter, v proto.Message) {
	data, err := protojson.Marshal(v)
	if err != nil {
		_Cognito_HTTPWriteErrorResponse(w, err)
		return
	}

	w.Header().Set("Content-Type", "application/json")
	w.WriteHeader(http.StatusOK)

	_, _ = w.Write(data)
}

// _Cognito_HTTPWriteErrorResponse writes error to HTTP response with error status code
func _Cognito_HTTPWriteErrorResponse(w http.ResponseWriter, e error) {
	s := status.Convert(e)

	w.Header().Set("Content-Type", "application/json")

	switch s.Code() {
	case codes.OK:
		w.WriteHeader(http.StatusOK)
	case codes.Canceled:
		w.WriteHeader(http.StatusGatewayTimeout)
	case codes.Unknown:
		w.WriteHeader(http.StatusInternalServerError)
	case codes.InvalidArgument:
		w.WriteHeader(http.StatusBadRequest)
	case codes.DeadlineExceeded:
		w.WriteHeader(http.StatusGatewayTimeout)
	case codes.NotFound:
		w.WriteHeader(http.StatusNotFound)
	case codes.AlreadyExists:
		w.WriteHeader(http.StatusConflict)
	case codes.PermissionDenied:
		w.WriteHeader(http.StatusForbidden)
	case codes.ResourceExhausted:
		w.WriteHeader(http.StatusTooManyRequests)
	case codes.FailedPrecondition:
		w.WriteHeader(http.StatusPreconditionFailed)
	case codes.Aborted:
		w.WriteHeader(http.StatusServiceUnavailable)
	case codes.OutOfRange:
		w.WriteHeader(http.StatusRequestedRangeNotSatisfiable)
	case codes.Unimplemented:
		w.WriteHeader(http.StatusNotImplemented)
	case codes.Internal:
		w.WriteHeader(http.StatusInternalServerError)
	case codes.Unavailable:
		w.WriteHeader(http.StatusServiceUnavailable)
	case codes.DataLoss:
		w.WriteHeader(http.StatusInternalServerError)
	case codes.Unauthenticated:
		w.WriteHeader(http.StatusUnauthorized)
	default:
		w.WriteHeader(http.StatusInternalServerError)
	}

	data, err := protojson.Marshal(s.Proto())
	if err != nil {
		panic(err)
	}

	_, _ = w.Write(data)
}

// NewCognitoHandler constructs new http.Handler for CognitoServer
func NewCognitoHandler(srv CognitoServer) http.Handler {
	router := mux.NewRouter()
	router.Handle("/eolymp.cognito.Cognito/CreateToken", _Cognito_CreateToken(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/IntrospectToken", _Cognito_IntrospectToken(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/CreateAuthorization", _Cognito_CreateAuthorization(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/RevokeToken", _Cognito_RevokeToken(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/Signout", _Cognito_Signout(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/CreateAccessKey", _Cognito_CreateAccessKey(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/DeleteAccessKey", _Cognito_DeleteAccessKey(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/ListAccessKeys", _Cognito_ListAccessKeys(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/CreateUser", _Cognito_CreateUser(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/VerifyEmail", _Cognito_VerifyEmail(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/UpdateEmail", _Cognito_UpdateEmail(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/UpdateProfile", _Cognito_UpdateProfile(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/UpdatePicture", _Cognito_UpdatePicture(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/UpdatePassword", _Cognito_UpdatePassword(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/StartRecovery", _Cognito_StartRecovery(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/CompleteRecovery", _Cognito_CompleteRecovery(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/IntrospectUser", _Cognito_IntrospectUser(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/DescribeUser", _Cognito_DescribeUser(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/ListUsers", _Cognito_ListUsers(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/IntrospectQuota", _Cognito_IntrospectQuota(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/IntrospectRoles", _Cognito_IntrospectRoles(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/ListRoles", _Cognito_ListRoles(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/UpdateRoles", _Cognito_UpdateRoles(srv)).Methods(http.MethodPost)
	router.Handle("/eolymp.cognito.Cognito/ListEntitlements", _Cognito_ListEntitlements(srv)).Methods(http.MethodPost)
	return router
}

func _Cognito_CreateToken(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &CreateTokenInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.CreateToken(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_IntrospectToken(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &IntrospectTokenInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.IntrospectToken(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_CreateAuthorization(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &CreateAuthorizationInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.CreateAuthorization(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_RevokeToken(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &RevokeTokenInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.RevokeToken(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_Signout(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &SignoutInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.Signout(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_CreateAccessKey(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &CreateAccessKeyInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.CreateAccessKey(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_DeleteAccessKey(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &DeleteAccessKeyInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.DeleteAccessKey(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_ListAccessKeys(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &ListAccessKeysInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.ListAccessKeys(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_CreateUser(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &CreateUserInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.CreateUser(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_VerifyEmail(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &VerifyEmailInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.VerifyEmail(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_UpdateEmail(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &UpdateEmailInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.UpdateEmail(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_UpdateProfile(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &UpdateProfileInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.UpdateProfile(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_UpdatePicture(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &UpdatePictureInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.UpdatePicture(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_UpdatePassword(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &UpdatePasswordInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.UpdatePassword(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_StartRecovery(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &StartRecoveryInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.StartRecovery(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_CompleteRecovery(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &CompleteRecoverInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.CompleteRecovery(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_IntrospectUser(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &IntrospectUserInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.IntrospectUser(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_DescribeUser(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &DescribeUserInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.DescribeUser(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_ListUsers(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &ListUsersInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.ListUsers(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_IntrospectQuota(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &IntrospectQuotaInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.IntrospectQuota(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_IntrospectRoles(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &IntrospectRolesInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.IntrospectRoles(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_ListRoles(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &ListRolesInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.ListRoles(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_UpdateRoles(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &UpdateRolesInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.UpdateRoles(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

func _Cognito_ListEntitlements(srv CognitoServer) http.Handler {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		in := &ListEntitlementsInput{}

		if err := _Cognito_HTTPReadRequestBody(r, in); err != nil {
			err = status.New(codes.InvalidArgument, err.Error()).Err()
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		out, err := srv.ListEntitlements(r.Context(), in)
		if err != nil {
			_Cognito_HTTPWriteErrorResponse(w, err)
			return
		}

		_Cognito_HTTPWriteResponse(w, out)
	})
}

var promCognitoRequestLatency = promauto.NewHistogramVec(prometheus.HistogramOpts{
	Name:    "cognito_request_latency",
	Help:    "Cognito request latency",
	Buckets: []float64{0.1, 0.4, 1, 5},
}, []string{"method", "status"})

type _CognitoLimiter interface {
	Allow(context.Context, string, float64, int) bool
}

type CognitoInterceptor struct {
	limiter _CognitoLimiter
	server  CognitoServer
}

// NewCognitoInterceptor constructs additional middleware for a server based on annotations in proto files
func NewCognitoInterceptor(srv CognitoServer, lim _CognitoLimiter) *CognitoInterceptor {
	return &CognitoInterceptor{server: srv, limiter: lim}
}

func (i *CognitoInterceptor) CreateToken(ctx context.Context, in *CreateTokenInput) (out *CreateTokenOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/CreateToken", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/CreateToken", 30, 300) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.CreateToken(ctx, in)
	return
}

func (i *CognitoInterceptor) IntrospectToken(ctx context.Context, in *IntrospectTokenInput) (out *IntrospectTokenOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/IntrospectToken", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/IntrospectToken", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.IntrospectToken(ctx, in)
	return
}

func (i *CognitoInterceptor) CreateAuthorization(ctx context.Context, in *CreateAuthorizationInput) (out *CreateAuthorizationOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/CreateAuthorization", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("password_grant") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: password_grant")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/CreateAuthorization", 0.16, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.CreateAuthorization(ctx, in)
	return
}

func (i *CognitoInterceptor) RevokeToken(ctx context.Context, in *RevokeTokenInput) (out *RevokeTokenOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/RevokeToken", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/RevokeToken", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.RevokeToken(ctx, in)
	return
}

func (i *CognitoInterceptor) Signout(ctx context.Context, in *SignoutInput) (out *SignoutOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/Signout", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/Signout", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.Signout(ctx, in)
	return
}

func (i *CognitoInterceptor) CreateAccessKey(ctx context.Context, in *CreateAccessKeyInput) (out *CreateAccessKeyOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/CreateAccessKey", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:access-key:write") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:access-key:write")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/CreateAccessKey", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.CreateAccessKey(ctx, in)
	return
}

func (i *CognitoInterceptor) DeleteAccessKey(ctx context.Context, in *DeleteAccessKeyInput) (out *DeleteAccessKeyOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/DeleteAccessKey", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:access-key:write") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:access-key:write")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/DeleteAccessKey", 5, 50) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.DeleteAccessKey(ctx, in)
	return
}

func (i *CognitoInterceptor) ListAccessKeys(ctx context.Context, in *ListAccessKeysInput) (out *ListAccessKeysOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/ListAccessKeys", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:access-key:read") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:access-key:read")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/ListAccessKeys", 20, 100) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.ListAccessKeys(ctx, in)
	return
}

func (i *CognitoInterceptor) CreateUser(ctx context.Context, in *CreateUserInput) (out *CreateUserOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/CreateUser", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/CreateUser", 10, 50) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.CreateUser(ctx, in)
	return
}

func (i *CognitoInterceptor) VerifyEmail(ctx context.Context, in *VerifyEmailInput) (out *VerifyEmailOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/VerifyEmail", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/VerifyEmail", 1, 1) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.VerifyEmail(ctx, in)
	return
}

func (i *CognitoInterceptor) UpdateEmail(ctx context.Context, in *UpdateEmailInput) (out *UpdateEmailOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/UpdateEmail", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/UpdateEmail", 1, 1) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.UpdateEmail(ctx, in)
	return
}

func (i *CognitoInterceptor) UpdateProfile(ctx context.Context, in *UpdateProfileInput) (out *UpdateProfileOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/UpdateProfile", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/UpdateProfile", 1, 5) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.UpdateProfile(ctx, in)
	return
}

func (i *CognitoInterceptor) UpdatePicture(ctx context.Context, in *UpdatePictureInput) (out *UpdatePictureOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/UpdatePicture", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/UpdatePicture", 1, 5) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.UpdatePicture(ctx, in)
	return
}

func (i *CognitoInterceptor) UpdatePassword(ctx context.Context, in *UpdatePasswordInput) (out *UpdatePasswordOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/UpdatePassword", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("password_grant") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: password_grant")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/UpdatePassword", 1, 5) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.UpdatePassword(ctx, in)
	return
}

func (i *CognitoInterceptor) StartRecovery(ctx context.Context, in *StartRecoveryInput) (out *StartRecoveryOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/StartRecovery", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/StartRecovery", 10, 50) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.StartRecovery(ctx, in)
	return
}

func (i *CognitoInterceptor) CompleteRecovery(ctx context.Context, in *CompleteRecoverInput) (out *CompleteRecoverOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/CompleteRecovery", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/CompleteRecovery", 10, 50) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.CompleteRecovery(ctx, in)
	return
}

func (i *CognitoInterceptor) IntrospectUser(ctx context.Context, in *IntrospectUserInput) (out *IntrospectUserOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/IntrospectUser", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/IntrospectUser", 10, 50) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.IntrospectUser(ctx, in)
	return
}

func (i *CognitoInterceptor) DescribeUser(ctx context.Context, in *DescribeUserInput) (out *DescribeUserOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/DescribeUser", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:user:read") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:user:read")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/DescribeUser", 200, 500) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.DescribeUser(ctx, in)
	return
}

func (i *CognitoInterceptor) ListUsers(ctx context.Context, in *ListUsersInput) (out *ListUsersOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/ListUsers", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:user:read") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:user:read")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/ListUsers", 15, 100) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.ListUsers(ctx, in)
	return
}

func (i *CognitoInterceptor) IntrospectQuota(ctx context.Context, in *IntrospectQuotaInput) (out *IntrospectQuotaOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/IntrospectQuota", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/IntrospectQuota", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.IntrospectQuota(ctx, in)
	return
}

func (i *CognitoInterceptor) IntrospectRoles(ctx context.Context, in *IntrospectRolesInput) (out *IntrospectRolesOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/IntrospectRoles", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/IntrospectRoles", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.IntrospectRoles(ctx, in)
	return
}

func (i *CognitoInterceptor) ListRoles(ctx context.Context, in *ListRolesInput) (out *ListRolesOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/ListRoles", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:role:read") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:role:read")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/ListRoles", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.ListRoles(ctx, in)
	return
}

func (i *CognitoInterceptor) UpdateRoles(ctx context.Context, in *UpdateRolesInput) (out *UpdateRolesOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/UpdateRoles", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	token, ok := oauth.TokenFromContext(ctx)
	if ok && !token.Has("cognito:role:read") {
		err = status.Error(codes.PermissionDenied, "required token scopes are missing: cognito:role:read")
		return
	}

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/UpdateRoles", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.UpdateRoles(ctx, in)
	return
}

func (i *CognitoInterceptor) ListEntitlements(ctx context.Context, in *ListEntitlementsInput) (out *ListEntitlementsOutput, err error) {
	start := time.Now()
	defer func() {
		s, _ := status.FromError(err)
		if s == nil {
			s = status.New(codes.OK, "OK")
		}

		promCognitoRequestLatency.WithLabelValues("eolymp.cognito.Cognito/ListEntitlements", s.Code().String()).
			Observe(time.Since(start).Seconds())
	}()

	if !i.limiter.Allow(ctx, "eolymp.cognito.Cognito/ListEntitlements", 1, 10) {
		err = status.Error(codes.ResourceExhausted, "too many requests")
		return
	}

	out, err = i.server.ListEntitlements(ctx, in)
	return
}
